import Logo from "../Logo";
import Button from "../Button";
import Input from "../Input";

import { useThemeContext } from "../../contexts/ThemeContext";
import { useAuthContext } from "../../contexts/AuthContext";

import { useEffect, useRef, useState } from "react";
import { fetchAction } from "../api/api";
import { useErrorContext } from "../../contexts/ErrorContext";

const SearchBar = () => {
	const { showError } = useErrorContext();
	const [text, setText] = useState("");
	const [data, setData] = useState([]);
	const searchInputRef = useRef(null);

	useEffect(() => {
		const aborController = new AbortController();
		const signal = aborController.signal;
		if (text === "") {
			setData(null);
			return;
		}

		fetchAction({
			path: `users?search=${text}`,
			options: {
				signal
			}
		}).then(({ data, error }) => {
			if (error) {
				return showError(error);
			}
			setData(data);
		});

		return () => {
			aborController.abort();
		};
	}, [text]);

	return (
		<div className="search-bar">
			<Input
				className="search-bar__input"
				key="search"
				inputRef={searchInputRef}
				name="search"
				type="search"
				id="search"
				value={text}
				onChange={(e) => setText(e.target.value)}
				placeholder="Search"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					height="24"
					viewBox="0 -960 960 960"
					width="24"
				>
					<path d="M781.692-136.924 530.461-388.155q-30 24.769-69 38.769t-80.692 14q-102.55 0-173.582-71.014t-71.032-173.537q0-102.524 71.014-173.601 71.014-71.076 173.538-71.076 102.523 0 173.6 71.032T625.384-580q0 42.846-14.385 81.846-14.385 39-38.385 67.846l251.231 251.231-42.153 42.153Zm-400.923-258.46q77.308 0 130.962-53.654Q565.385-502.692 565.385-580q0-77.308-53.654-130.962-53.654-53.654-130.962-53.654-77.308 0-130.962 53.654Q196.154-657.308 196.154-580q0 77.308 53.653 130.962 53.654 53.654 130.962 53.654Z" />
				</svg>
			</Input>
			{data && (
				<div className="column search-bar__list">
					{data.map((item) => (
						<div key={item.id} className="search-bar__row">
							<a href={`/users/${item.nickname}`}>
								<div className="search-bar__item">
									<figure>
										<img
											src={`/uploads/profile/${
												item.profile_img || "default.png"
											}`}
											alt={item.nickname}
										/>
									</figure>
									<div className="name">
										<span>{item.nickname}</span>
									</div>
								</div>
							</a>
						</div>
					))}
				</div>
			)}
		</div>
	);
};

const Navbar = () => {
	const { isAuthenticated, signOut } = useAuthContext();
	const { theme, setTheme } = useThemeContext();
	const [isVisible, setIsVisible] = useState(false);
	function handleToggleTheme() {
		setTheme(theme === "dark" ? "light" : "dark");
		localStorage.setItem("theme", theme === "dark" ? "light" : "dark");
	}

	const targetSmallScreen = window.matchMedia("(max-width: 600px)").matches;

	return (
		<nav>
			<div>
				<div className="nav">
					<div>
						<Logo />
					</div>
					<div className="search-bar__wrapper">
						{(isVisible || !targetSmallScreen) && <SearchBar />}
					</div>
					<div className="nav__menu">
						<div className="nav__menu__item">
							{targetSmallScreen && (
								<Button onClick={() => setIsVisible(!isVisible)}>
									<svg
										xmlns="http://www.w3.org/2000/svg"
										height="24"
										viewBox="0 -960 960 960"
										width="24"
									>
										<path d="M781.692-136.924 530.461-388.155q-30 24.769-69 38.769t-80.692 14q-102.55 0-173.582-71.014t-71.032-173.537q0-102.524 71.014-173.601 71.014-71.076 173.538-71.076 102.523 0 173.6 71.032T625.384-580q0 42.846-14.385 81.846-14.385 39-38.385 67.846l251.231 251.231-42.153 42.153Zm-400.923-258.46q77.308 0 130.962-53.654Q565.385-502.692 565.385-580q0-77.308-53.654-130.962-53.654-53.654-130.962-53.654-77.308 0-130.962 53.654Q196.154-657.308 196.154-580q0 77.308 53.653 130.962 53.654 53.654 130.962 53.654Z" />
									</svg>
								</Button>
							)}
						</div>
						<div className="nav__menu__item">
							<Button onClick={handleToggleTheme} label="Toggle theme">
								{theme === "light" ? (
									<svg
										aria-hidden="true"
										focusable="false"
										xmlns="http://www.w3.org/2000/svg"
										height="24"
										viewBox="0 -960 960 960"
										width="24"
									>
										<path d="M481.154-140.001q-141.666 0-240.832-99.167Q141.155-338.334 141.155-480q0-135.768 92.115-232.883 92.114-97.115 225.575-105.192 8.615 0 16.922.615t16.307 1.846q-30.615 28.615-48.768 69.153-18.154 40.539-18.154 86.461 0 98.334 68.834 167.168 68.834 68.833 167.168 68.833 46.538 0 86.768-18.153 40.23-18.153 68.461-48.768 1.231 8 1.846 16.307.616 8.307.616 16.922-7.693 133.461-104.808 225.575-97.115 92.115-232.883 92.115Zm0-59.999q88 0 158-48.5t102-126.5q-20 5-40 8t-40 3q-123 0-209.5-86.5t-86.5-209.5q0-20 3-40t8-40q-78 32-126.5 102t-48.5 158q0 116 82 198t198 82Zm-10-270Z" />
									</svg>
								) : (
									<svg
										aria-hidden="true"
										focusable="false"
										xmlns="http://www.w3.org/2000/svg"
										height="24"
										viewBox="0 -960 960 960"
										width="24"
									>
										<path d="M480-360q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Zm0 59.999q-74.922 0-127.461-52.538Q300.001-405.078 300.001-480t52.538-127.461Q405.078-659.999 480-659.999t127.461 52.538Q659.999-554.922 659.999-480t-52.538 127.461Q554.922-300.001 480-300.001Zm-400-150q-12.75 0-21.374-8.628Q50-467.258 50-480.013q0-12.756 8.625-21.371 8.624-8.615 21.374-8.615h90.001q12.749 0 21.374 8.628Q200-492.742 200-479.987q0 12.756-8.625 21.371-8.625 8.615-21.374 8.615H80Zm709.999 0q-12.749 0-21.374-8.628Q760-467.258 760-480.013q0-12.756 8.625-21.371 8.625-8.615 21.374-8.615H880q12.75 0 21.375 8.628 8.624 8.629 8.624 21.384 0 12.756-8.624 21.371-8.625 8.615-21.375 8.615h-90.001ZM479.987-760q-12.756 0-21.371-8.625-8.615-8.625-8.615-21.374V-880q0-12.75 8.628-21.375 8.629-8.624 21.384-8.624 12.756 0 21.371 8.624 8.615 8.625 8.615 21.375v90.001q0 12.749-8.628 21.374Q492.742-760 479.987-760Zm0 710q-12.756 0-21.371-8.626-8.615-8.624-8.615-21.374v-90.001q0-12.749 8.628-21.374Q467.258-200 480.013-200q12.756 0 21.371 8.625 8.615 8.625 8.615 21.374V-80q0 12.75-8.628 21.374Q492.742-50 479.987-50ZM240.232-678.386l-50.308-48.923q-8.923-8.308-8.616-20.884.308-12.577 8.733-21.884 9.19-9.308 21.574-9.308 12.385 0 21.077 9.308L282-720.153q8.692 9.308 8.692 21.077 0 11.769-8.5 21.076-8.499 9.307-20.576 8.807t-21.384-9.192Zm487.076 488.461L678-239.847q-8.692-9.308-8.692-21.384 0-12.077 8.692-20.769 8.115-9.307 20.288-8.807t21.48 9.192l50.308 48.923q8.923 8.308 8.616 20.884-.308 12.577-8.733 21.884-9.19 9.308-21.574 9.308-12.385 0-21.077-9.308ZM678-677.808q-9.307-8.499-8.807-20.576t9.192-21.384l48.923-50.308q8.308-8.923 20.884-8.616 12.577.308 21.884 8.733 9.308 9.19 9.308 21.574 0 12.385-9.308 21.077L720.153-678q-9.308 8.692-21.077 8.692-11.769 0-21.076-8.5ZM189.924-189.84q-9.308-9.391-9.308-21.775 0-12.385 9.308-21.077L239.847-282q9.308-8.692 21.384-8.692 12.077 0 20.769 8.692 8.923 8.115 8.423 20.288t-8.808 21.48l-48.923 50.308q-8.692 9.308-21.077 9-12.384-.307-21.691-8.916ZM480-480Z" />
									</svg>
								)}
							</Button>
						</div>
						<div className="nav__menu__item">
							<a href="/settings" className="btn-anchor">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									height="24"
									viewBox="0 -960 960 960"
									width="24"
								>
									<path d="m387.694-100.001-15.231-121.846q-16.077-5.385-32.962-15.077-16.885-9.693-30.193-20.77l-112.846 47.692L104.156-370l97.615-73.769q-1.385-8.923-1.962-17.923-.577-9-.577-17.923 0-8.539.577-17.347.577-8.808 1.962-19.269L104.156-590l92.306-159.229 112.461 47.308q14.462-11.462 30.885-20.962 16.424-9.501 32.27-15.27l15.616-121.846h184.612l15.231 122.231q18 6.538 32.578 15.269 14.577 8.731 29.423 20.578l114-47.308L855.844-590l-99.153 74.922q2.154 9.693 2.346 18.116.192 8.423.192 16.962 0 8.154-.384 16.577-.385 8.423-2.77 19.27L854.46-370l-92.307 159.998-112.615-48.077q-14.846 11.847-30.308 20.962-15.462 9.116-31.693 14.885l-15.231 122.231H387.694ZM440-160h78.615L533-267.154q30.615-8 55.961-22.731 25.346-14.73 48.885-37.884L737.231-286l39.384-68-86.769-65.385q5-15.538 6.808-30.461 1.807-14.923 1.807-30.154 0-15.615-1.807-30.154-1.808-14.538-6.808-29.692L777.385-606 738-674l-100.539 42.385q-20.076-21.462-48.115-37.923-28.039-16.462-56.731-23.308L520-800h-79.385l-13.23 106.769q-30.616 7.231-56.539 22.154-25.923 14.923-49.461 38.462L222-674l-39.385 68L269-541.615q-5 14.23-7 29.615-2 15.385-2 32.385Q260-464 262-449q2 15 6.615 29.615l-86 65.385L222-286l99-42q22.769 23.385 48.692 38.308 25.923 14.923 57.308 22.923L440-160Zm40.461-200.001q49.923 0 84.961-35.038Q600.46-430.078 600.46-480t-35.038-84.961q-35.038-35.038-84.961-35.038-50.537 0-85.268 35.038-34.73 35.039-34.73 84.961t34.73 84.961q34.731 35.038 85.268 35.038ZM480-480Z" />
								</svg>
							</a>
						</div>
						<div className="nav__menu__item">
							<a href="/login" onClick={signOut}>
								{isAuthenticated ? "Logout" : "Login"}
							</a>
						</div>
					</div>
				</div>
			</div>
		</nav>
	);
};

export default Navbar;
